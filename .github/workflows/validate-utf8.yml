
name: Validate UTF-8 (æ/ø/å)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  utf8:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up R
        uses: r-lib/actions/setup-r@v2

      - name: Validate UTF-8 encoding
        run: |
          Rscript - <<'RSCRIPT'
          files <- list.files('.', pattern='\.(R|r|md|MD|txt|csv)$', recursive=TRUE, full.names=TRUE)
          if (length(files)==0) { cat('No text files to check.
'); quit(save='no', status=0) }
          bad <- character()
          for (f in files) {
            ok <- TRUE
            tryCatch({
              lines <- readLines(f, encoding='UTF-8', warn=FALSE)
              # round-trip through iconv
              rt <- iconv(lines, from='UTF-8', to='UTF-8')
              if (any(is.na(rt))) ok <- FALSE
            }, error=function(e) ok <<- FALSE)
            if (!ok) bad <- c(bad, f)
          }
          if (length(bad)>0) {
            cat('The following files are not valid UTF-8 (or failed to read as UTF-8):
')
            print(bad)
            quit(save='no', status=1)
          }
          # Explicit æ/ø/å sanity
          s <- 'æøå ÆØÅ'
          if (!identical(Encoding(s), 'unknown')) s <- enc2utf8(s)
          cat('[OK] UTF-8 validation passed, æ/ø/å looks fine.
')
          RSCRIPT
