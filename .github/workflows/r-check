
name: R modules - basic check

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  check-r:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up R
        uses: r-lib/actions/setup-r@v2

      - name: Install system dependencies (for odbc etc.)
        run: |
          sudo apt-get update
          sudo apt-get install -y unixodbc-dev libcurl4-openssl-dev libssl-dev libxml2-dev libfontconfig1-dev libharfbuzz-dev libfribidi-dev

      - name: Install R packages
        run: |
          Rscript -e "install.packages(c('tidyverse','lubridate','DBI','odbc','writexl'), repos='https://cloud.r-project.org', dependencies=TRUE)"

      - name: Sanity check - source modules
        run: |
          Rscript - <<'RSCRIPT'
          modules <- c('01_config.R','07_runbook.R','02_powerbi_io.R','03_lopenr.R','04_geo_fix.R','05_delivery.R','06_pipeline.R')
          stopifnot(dir.exists('R'))
          missing <- modules[!file.exists(file.path('R', modules))]
          if (length(missing)>0) stop('Missing modules: ', paste(missing, collapse=', '))
          for (m in modules) source(file.path('R', m))
          cat('[OK] Modules sourced without errors
')
          RSCRIPT
