
name: Run STEP tests (no-DB demo)

on:
  workflow_dispatch:

jobs:
  run-steps:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        step: [ STEP1, STEP2 ]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up R
        uses: r-lib/actions/setup-r@v2

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y unixodbc-dev libcurl4-openssl-dev libssl-dev libxml2-dev

      - name: Install R packages
        run: |
          Rscript -e "install.packages(c('tidyverse','lubridate','DBI','odbc','writexl'), repos='https://cloud.r-project.org', dependencies=TRUE)"

      - name: Prepare demo input (PowerBI CSVs)
        run: |
          # Create base dirs with RHF names (HSØ, HV, HMN)
          BASE=demo_base
          mkdir -p "$BASE/HSØ" "$BASE/HV" "$BASE/HMN"
          # Minimal CSV content with NPRId and KommuneNr
          for R in HSØ HV HMN; do             printf 'NPRId;KommuneNr
12345;0301
' > "$BASE/$R/Forlopstider_RHF_${R}.csv";           done
          # Create app_dir + out_dir
          mkdir -p demo_app demo_out

      - name: Create USER_local.R (no DB for CI)
        run: |
          cat > config/USER_local.R <<'RCONF'
          USER <- list(
            step = "${{ matrix.step }}",
            months = c("2025-12-01"),
            base_dir = normalizePath('demo_base'),
            app_dir  = normalizePath('demo_app'),
            out_dir  = normalizePath('demo_out'),
            fill_missing_kommune = FALSE,
            drop_column_M = TRUE,
            use_parquet_cache = FALSE,
            qc_simple = TRUE,
            verbose = TRUE
          )
          RCONF

      - name: If STEP2, create dummy *_lnr.csv
        if: matrix.step == 'STEP2'
        run: |
          printf '12345;10001
' > demo_app/NPRId_RHF_Pakkeforløp_des25_lnr.csv

      - name: Run 00_run.R
        run: Rscript scripts/00_run.R

      - name: Upload outputs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: outputs-${{ matrix.step }}
          path: demo_out
